<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Результаты олимпиады</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f5f7ff;
        margin: 0;
        padding: 40px 20px;
        color: #333;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        padding: 40px;
      }

      h1 {
        text-align: center;
        background: linear-gradient(90deg, #6574cd, #c56f5a);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 30px;
        margin-bottom: 30px;
        margin-top: 0px;
        font-weight: 700;
      }

      .subtitle {
        text-align: center;
        color: #777;
        margin-bottom: 30px;
      }

      .filter {
        display: flex;
        justify-content: center;
        margin-bottom: 24px;
        gap: 12px;
        flex-wrap: wrap;
      }

      .filter select,
      .filter input {
        padding: 10px 14px;
        border: 1px solid #ccc;
        border-radius: 12px;
        font-size: 15px;
        min-width: 180px;
      }

      .participants {
        margin-top: 20px;
      }

      .participant-item {
        background: #f9fafc;
        border: 1px solid #e0e0ff;
        border-radius: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .participant-item:hover {
        background: #f0f4ff;
      }

      .participant-header {
        padding: 16px 20px;
        font-size: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 500;
        color: #333;
      }

      .participant-header::after {
        content: "+";
        font-size: 20px;
        color: #7d8ff5;
        font-weight: bold;
      }

      .participant-header.open::after {
        content: "−";
      }

      .participant-info {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .num {
        font-weight: 700;
        color: #6574cd;
        min-width: 30px;
      }

      .details {
        display: none;
        padding: 20px;
        background: #f8faff;
        border-top: 1px dashed #bfcfff;
        border-radius: 0 0 16px 16px;
        color: #444;
        line-height: 1.6;
      }

      .details p {
        margin: 8px 0;
        font-size: 15px;
      }

      .details a {
        color: #7d8ff5;
        text-decoration: none;
      }

      .details a:hover {
        text-decoration: underline;
      }

      .empty {
        text-align: center;
        color: #999;
        padding: 30px;
        font-style: italic;
      }

      footer {
        text-align: center;
        margin-top: 40px;
        color: #aaa;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Результаты олимпиады</h1>

      <div class="filter">
        <select id="classFilter">
          <option value="">Все классы</option>
          <option value="4">4 класс</option>
          <option value="5">5 класс</option>
          <option value="6">6 класс</option>
          <option value="7">7 класс</option>
          <option value="8">8 класс</option>
          <option value="9">9 класс</option>
          <option value="10">10 класс</option>
          <option value="11">11 класс</option>
        </select>

        <select id="levelFilter">
          <option value="">Все уровни</option>
          <option value="Сложность: Начальный уровень (5–6 класс)">Сложность: Начальный уровень (5–6 класс)</option>
          <option value="Сложность: Средний уровень (7–9 класс)">Сложность: Средний уровень (7–9 класс)</option>
        </select>

        <input type="text" id="searchInput" placeholder="Поиск по фамилии..." />
      </div>

      <div class="participants" id="participantsList">
        <div class="empty">Загрузка данных...</div>
      </div>

      <footer>© 2025 Iserv Образование</footer>
    </div>

    <script>
      const participantsList = document.getElementById("participantsList");
      const classFilter = document.getElementById("classFilter");
      const searchInput = document.getElementById("searchInput");
      let allData = []; // Храним все данные

      // === Функция: извлекает ID проекта и возвращает iframe ===
      function embedScratchProject(url) {
        try {
          const match = url.trim().match(/\/projects\/(\d+)/);
          if (!match) {
            return "<p><em>Некорректная ссылка</em></p>";
          }
          const projectId = match[1];
          const iframe = `
        <div style="text-align: center; margin: 10px 0;">
            <iframe 
            src="https://scratch.mit.edu/projects/${projectId}/embed"
            width="485" 
            height="402" 
            style="
                border: none; 
                border-radius: 12px; 
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                max-width: 100%;
            "
            frameborder="0" 
            scrolling="no" 
            allowfullscreen
            allow="clipboard-read; clipboard-write"
            ></iframe>
            <p style="margin-top: 8px; font-size: 13px; color: #666;">
            <a href="${url}" target="_blank" style="color: #7d8ff5;">Открыть в новой вкладке</a>
            </p>
        </div>
        `;
          return iframe;
        } catch (e) {
          return "<p><em>Ошибка при загрузке проекта</em></p>";
        }
      }

      // Загрузка данных из Google Sheets
      async function loadData() {
        try {
          participantsList.innerHTML =
            '<div class="empty">Загрузка данных...</div>';

          const response = await fetch(
            "https://script.google.com/macros/s/AKfycbwoYk_H0hwgpuQnmxJ7XvTd9R8Td7vK-_AW4azseoItXZU-oPH9PMiy3jRhNcIoJvPB/exec"
          );
          const result = await response.json();

          if (result.error) {
            participantsList.innerHTML = `<div class="empty">Ошибка загрузки: ${result.details}</div>`;
            console.error(result);
            return;
          }

          allData = result.data;
          filterData(); // Отображаем данные
        } catch (err) {
          participantsList.innerHTML = `<div class="empty">Не удалось подключиться к таблице. Проверьте соединение.</div>`;
          console.error(err);
        }
      }

      function renderList(data) {
        if (!data || data.length === 0) {
          participantsList.innerHTML = `<div class="empty">Нет участников по заданным критериям</div>`;
          return;
        }

        participantsList.innerHTML = data
          .map(
            (item, index) => `
            <div class="participant-item" data-index="${index}">
            <div class="participant-header">
                <div class="participant-info">
                <span class="num">${index + 1}.</span>
                <span><strong>${item.familiya || ""} ${item.imya || ""} ${
              item.otchestvo || ""
            }</strong></span>
                <span>· ${item.class || "?"} класс</span>
                <span>· ${item.telephon || "Телефон не указан"}</span>
                <span>· ${item.vremya || "—"}</span>
                </div>
            </div>
            <div class="details">
                <p><strong>Задание 1:</strong> ${item.q1 || "—"}</p>
                <p><strong>Задание 2:</strong> ${item.q2 || "—"}</p>
                <p><strong>Задание 3:</strong> ${item.q3 || "—"}</p>
                <p><strong>Задание 4:</strong> ${item.q4 || "—"}</p>
                <p><strong>Задание 5:</strong> ${item.q5 || "—"}</p>

                <!-- Задание 6 -->
                <p><strong>Задание 6 (DVD):</strong></p>
                ${
                  item.task6
                    ? embedScratchProject(item.task6)
                    : "<p><em>Проект не загружен</em></p>"
                }

                <!-- Задание 7 -->
                <p><strong>Задание 7 (Секундомер):</strong></p>
                ${
                  item.task7
                    ? embedScratchProject(item.task7)
                    : "<p><em>Проект не загружен</em></p>"
                }

                <!-- Задание 8 -->
                <p><strong>Задание 8 (Крестики-нолики):</strong></p>
                ${
                  item.task8
                    ? embedScratchProject(item.task8)
                    : "<p><em>Проект не загружен</em></p>"
                }
            </div>
            </div>
        `
          )
          .join("");

        // Обработчики кликов
        document.querySelectorAll(".participant-header").forEach((header) => {
          header.addEventListener("click", function () {
            const details = this.nextElementSibling;
            details.style.display =
              details.style.display === "block" ? "none" : "block";
          });
        });
      }

      function filterData() {
        const classValue = classFilter.value;
        const levelValue = levelFilter.value; // "Начальный" или "Средний"
        const searchValue = searchInput.value.toLowerCase().trim();

        let filtered = allData;

        // Фильтр по классу
        if (classValue) {
            filtered = filtered.filter(d => d.class == classValue);
        }

        // Фильтр по уровню сложности
        if (levelValue) {
            filtered = filtered.filter(d => {
            const slozhnost = d.slojnost || '';
            if (levelValue === "Сложность: Начальный уровень (5–6 класс)") return slozhnost.includes("Сложность: Начальный уровень (5–6 класс)");
            if (levelValue === "Сложность: Средний уровень (7–9 класс)") return slozhnost.includes("Сложность: Средний уровень (7–9 класс)");
            return false;
            });
        }

        // Поиск по ФИО
        if (searchValue) {
            filtered = filtered.filter(d => 
            (d.familiya || '').toLowerCase().includes(searchValue) ||
            (d.imya || '').toLowerCase().includes(searchValue) ||
            (d.otchestvo || '').toLowerCase().includes(searchValue)
            );
        }

        renderList(filtered);
        }


      // Слушатели
      classFilter.addEventListener("change", filterData);
      levelFilter.addEventListener("change", filterData);
      searchInput.addEventListener("input", filterData);

      // Загрузка при старте
      window.addEventListener("load", loadData);
    </script>
  </body>
</html>
